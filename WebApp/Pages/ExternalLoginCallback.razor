@page "/external-login-callback"
@using SharedModels.Requests.Auth
@using Microsoft.AspNetCore.WebUtilities
@using SharedModels.Responses.Auth
@inject IHttpClientFactory _httpClientFactory
@inject ILocalStorageService _localStorage
@inject AuthenticationStateProvider _authStateProvider
@inject NavigationManager _navigationManager

@code {
    private HttpClient httpClient = null;
    ExternalLoginTokensRequest externalLoginTokensRequest = new();

    protected override async Task OnInitializedAsync()
    {
        httpClient = _httpClientFactory.CreateClient(Constants.HttpClientName);
        MapQueryStringValuesToRequest();
        await PostRequest();
        _navigationManager.NavigateTo("/");
    }

    private void MapQueryStringValuesToRequest()
    {
        var uri = _navigationManager.ToAbsoluteUri(_navigationManager.Uri);
        if (QueryHelpers.ParseQuery(uri.Query).TryGetValue("email", out var email))
        {
            externalLoginTokensRequest.Email = email;
        }

        if (QueryHelpers.ParseQuery(uri.Query).TryGetValue("provider", out var provider))
        {
            externalLoginTokensRequest.Provider = provider;
        }
    }

    private async Task PostRequest()
    {
        var httpResponse = await httpClient.PostAsJsonAsync("auth/external-login-tokens", externalLoginTokensRequest);
        if (httpResponse.IsSuccessStatusCode)
        {
            var tokenResponse = await httpResponse.Content.ReadFromJsonAsync<TokenResponse>();
            await _localStorage.SetItemAsync("accessToken", tokenResponse.AccessToken);
            ((AuthStateProvider)_authStateProvider).NotifyUserAuthentication(tokenResponse.AccessToken);
        }
    }
}