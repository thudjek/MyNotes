@page "/forgot-password"
@layout NotAuthorizedLayout
@using SharedModels.Requests.Auth
@inject IHttpClientFactory _httpClientFactory
@inject ErrorPopupService _errorPopupService

@if (!isSubmitSuccessful)
{
    <EditForm Model="@forgotPasswordRequest" OnSubmit="SubmitForgotPassword">
        <CustomValidator @ref="customValidator" />
        <div class="row">
            <div class="col-8 offset-2 col-md-6 offset-md-3 col-lg-5 offset-lg-3point5 col-xl-4 offset-xl-4 mb-3 text-start">
                <InputText class="form-control input" placeholder="Email" @bind-Value=forgotPasswordRequest.Email />
                <ValidationMessage For="() => forgotPasswordRequest.Email" />
            </div>
        </div>
        <div class="row">
            <div class="col-8 offset-2 col-md-6 offset-md-3 col-lg-5 offset-lg-3point5 col-xl-4 offset-xl-4 mb-3">
                <button class="btn btn-primary w-100" type="submit">Submit</button>
            </div>
        </div>
    </EditForm>
}
else
{
    <h3>We've sent you email with link for reseting password.</h3>
}

@code {
    private bool isSubmitSuccessful = false;
    private ForgotPasswordRequest forgotPasswordRequest = new();
    private HttpClient httpClient = null;
    CustomValidator customValidator;

    protected override void OnInitialized()
    {
        httpClient = _httpClientFactory.CreateClient(Constants.HttpClientName);
    }

    private async Task SubmitForgotPassword()
    {
        var httpResponse = await httpClient.PostAsJsonAsync("auth/forgot-password", forgotPasswordRequest);
        if (httpResponse.IsSuccessStatusCode)
        {
            isSubmitSuccessful = true;
        }
        else
        {
            var errorModel = await httpResponse.Content.ReadFromJsonAsync<ErrorModel>();
            if (errorModel.Errors != null)
            {
                customValidator.ClearErrors();
                customValidator.DisplayErrors(errorModel.ErrorsGrouped);
            }
            else
            {
                _errorPopupService.ShowErrorPopup(errorModel.Error);
            }
        }
    }
}