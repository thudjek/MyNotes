@page "/"
@using SharedModels.Responses.Notes
@attribute [Authorize]
@inject IHttpClientFactory _httpClientFactory
@inject PopupMessageService _popupMessageService
@inject ILocalStorageService _localStorage
@inject RefreshTokenService _refreshTokenService


@code {
    private HttpClient httpClient = null;
    private List<NoteResponse> notes = null;

    protected override async Task OnInitializedAsync()
    {
        httpClient = _httpClientFactory.CreateClient(Constants.HttpClientName);
        await _refreshTokenService.TryRefreshToken();
        await GetNotes();
    }

    private async Task GetNotes()
    {
        var accessToken = await _localStorage.GetItemAsync<string>("accessToken");
        httpClient.DefaultRequestHeaders.Add("Authorization", $"Bearer {accessToken}");
        var httpResponse = await httpClient.GetAsync("notes", HttpCompletionOption.ResponseHeadersRead);
        if (httpResponse.IsSuccessStatusCode)
        {
            notes = await httpResponse.Content.ReadFromJsonAsync<List<NoteResponse>>();
        }
        else
        {
            var errorModel = await httpResponse.Content.ReadFromJsonAsync<ErrorModel>();
            _popupMessageService.ShowPopup(errorModel.Error, PopupMessageType.Error);
        }
        httpClient.DefaultRequestHeaders.Clear();
    }
}